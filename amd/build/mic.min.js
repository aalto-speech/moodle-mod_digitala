define("mod_digitala/mic",["exports","RecordRTC","core/config","core/str"],(function(_exports,_RecordRTC,_config,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}var recorder;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.initializeMicrophone=void 0,_RecordRTC=_interopRequireDefault(_RecordRTC),_config=_interopRequireDefault(_config);var audio,langStrings,pagenum,assignmentId,userId,username,maxLength,timeout,interval,sec,_ref,_ref2,recButton=document.getElementById("record"),listenButton=document.getElementById("listen"),startRecording=(_ref=_asyncToGenerator(regeneratorRuntime.mark((function _callee(){return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:if(!navigator.permissions){_context.next=4;break}navigator.permissions.query({name:"microphone"}).then((function(result){if("granted"!=result.state)return"prompt"==result.state?(navigator.mediaDevices.getUserMedia({audio:!0}),void(recButton.textContent=langStrings[2])):void("denied"!=result.state||(recButton.textContent=langStrings[3]))})),_context.next=19;break;case 4:return _context.next=6,navigator.mediaDevices.enumerateDevices();case 6:if(_context.t0=_context.sent[0].label,""!==_context.t0){_context.next=19;break}return _context.prev=9,navigator.mediaDevices.getUserMedia({audio:!0}),recButton.textContent=langStrings[2],_context.abrupt("return");case 15:return _context.prev=15,_context.t1=_context.catch(9),recButton.textContent=langStrings[3],_context.abrupt("return");case 19:if(clearTimeout(timeout),clearInterval(interval),void 0===navigator.mediaDevices){_context.next=25;break}navigator.mediaDevices.getUserMedia({audio:!0}).then((function(stream){var options={audioBitsPerSecond:16e3,desiredSampRate:16e3,type:"audio",recorderType:_RecordRTC.default.StereoAudioRecorder,mimeType:"audio/wav",numberOfAudioChannels:1,disableLogs:!0};(recorder=new _RecordRTC.default(stream,options)).startRecording(),window.console.log("Digitala: Started to record"),recButton.innerHTML="<span>"+langStrings[1]+"</span> "+document.getElementById("stopIcon").innerHTML,recButton.onclick=stopRecording,listenButton.disabled=!0,sec=0,interval=setInterval((function(){var seconds,hours,minutes,second;sec+=1,document.getElementById("recordingLength").textContent=(seconds=sec,hours=Math.floor(seconds/3600),minutes=Math.floor((seconds-3600*hours)/60),second=Math.floor(seconds-3600*hours-60*minutes),hours=0===hours?"":hours<10?"0".concat(hours,":"):"".concat(hours,":"),minutes=minutes<10?"0".concat(minutes):"".concat(minutes),second=second<10?"0".concat(second):"".concat(second),"".concat(hours).concat(minutes,":").concat(second))}),1e3),1==pagenum&&0!==maxLength&&(timeout=setTimeout((function(){stopRecording()}),1e3*maxLength))})).catch((function(){recButton.textContent=langStrings[3]})),_context.next=27;break;case 25:return recButton.textContent=langStrings[3],_context.abrupt("return");case 27:case"end":return _context.stop()}}),_callee,null,[[9,15]])}))),function(){return _ref.apply(this,arguments)}),stopRecording=function(){"recording"===recorder.getState()&&(recorder.stopRecording((function(){clearTimeout(timeout),clearInterval(interval);var audioBlob=recorder.getBlob(),audioUrl=URL.createObjectURL(audioBlob);if(audio=new Audio(audioUrl),1===pagenum){var form=new FormData;form.append("repo_id","5"),form.append("ctx_id",_config.default.contextid),form.append("itemid","0"),form.append("savepath","/"),form.append("sesskey",_config.default.sesskey),form.append("repo_upload_file",audioBlob,"ans-".concat(assignmentId,"-").concat(userId,"-").concat(username,"-").concat((new Date).valueOf(),".wav")),form.append("overwrite","1");var req=new XMLHttpRequest;req.open("POST",_config.default.wwwroot+"/repository/repository_ajax.php?action=upload"),req.addEventListener("readystatechange",(function(event){4===event.target.readyState&&(document.forms.answerrecording[0].value=event.target.response,document.forms.answerrecording[1].value=sec,document.getElementById("submitModalButton").style.display="")})),req.send(form)}recButton.innerHTML="<span>"+langStrings[0]+"</span> "+document.getElementById("startIcon").innerHTML,recButton.onclick=startRecording,listenButton.disabled=!1})),window.console.log("Digitala: Recording stopped"))},listenRecording=function(){var microphoneIcon=document.getElementById("microphoneIconBox");void 0!==audio?(audio.play(),0===pagenum&&(microphoneIcon.style.border="2.5px dashed green")):0===pagenum&&(microphoneIcon.style.border="2.5px dashed red")},initializeMicrophone=(_ref2=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(pagenumIn,assignmentIdIn,userIdIn,usernameIn,maxLengthIn){return regeneratorRuntime.wrap((function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:return window.console.log("Digitala: Starting to initalize microphones"),pagenum=pagenumIn,assignmentId=assignmentIdIn,userId=userIdIn,username=usernameIn,maxLength=maxLengthIn,_context2.next=8,(0,_str.get_strings)([{key:"startbutton-again",component:"digitala"},{key:"stopbutton",component:"digitala"},{key:"startbutton-no_permissions",component:"digitala"},{key:"startbutton-error",component:"digitala"}]);case 8:langStrings=_context2.sent,2!==pagenum&&(recButton.onclick=startRecording,listenButton.onclick=listenRecording);case 10:case"end":return _context2.stop()}}),_callee2)}))),function(_x,_x2,_x3,_x4,_x5){return _ref2.apply(this,arguments)});_exports.initializeMicrophone=initializeMicrophone}));

//# sourceMappingURL=mic.min.js.map